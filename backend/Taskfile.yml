version: '3'

# Taskfile for Time Manager Backend CI/CD
# Install task: https://taskfile.dev

vars:
  DATABASE_URL: postgres://postgres:postgres@localhost:5432/timemanager
  TEST_DATABASE_URL: postgres://postgres:postgres@localhost:5432/timemanager_test
  DOCKER_COMPOSE_FILE: ../docker-compose.yml

env:
  DATABASE_URL: '{{.DATABASE_URL}}'
  TEST_DATABASE_URL: '{{.TEST_DATABASE_URL}}'
  RUST_LOG: info
  RUST_BACKTRACE: 1

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # Database tasks
  db:up:
    desc: Start PostgreSQL database with Docker Compose
    dir: ..
    cmds:
      - docker-compose up -d postgres

  db:down:
    desc: Stop PostgreSQL database
    dir: ..
    cmds:
      - docker-compose down

  db:reset:
    desc: Reset database (drop, create, migrate)
    cmds:
      - cmd: task db:down
      - cmd: task db:up
      - cmd: sleep 2
      - cmd: diesel database reset --database-url={{.DATABASE_URL}}
      - cmd: diesel migration run --database-url={{.DATABASE_URL}}

  db:migrate:
    desc: Run database migrations
    cmds:
      - diesel migration run --database-url={{.DATABASE_URL}}

  db:migrate:redo:
    desc: Redo last migration
    cmds:
      - diesel migration redo --database-url={{.DATABASE_URL}}

  db:setup:
    desc: Setup database for development
    cmds:
      - cmd: task db:up
      - cmd: sleep 2
      - cmd: diesel database setup --database-url={{.DATABASE_URL}}

  # Test database tasks
  test:db:setup:
    desc: Setup test database
    cmds:
      - cmd: task db:up
      - cmd: sleep 2
      - cmd: diesel database setup --database-url={{.TEST_DATABASE_URL}}

  test:db:reset:
    desc: Reset test database
    cmds:
      - diesel database reset --database-url={{.TEST_DATABASE_URL}}
      - diesel migration run --database-url={{.TEST_DATABASE_URL}}

  # Build tasks
  build:
    desc: Build the project
    cmds:
      - cargo build

  build:release:
    desc: Build the project in release mode
    cmds:
      - cargo build --release

  # Code quality tasks
  fmt:
    desc: Format code with rustfmt
    cmds:
      - cargo fmt

  fmt:check:
    desc: Check code formatting
    cmds:
      - cargo fmt -- --check

  clippy:
    desc: Run Clippy linter
    cmds:
      - cargo clippy -- -D warnings

  clippy:fix:
    desc: Auto-fix Clippy warnings
    cmds:
      - cargo clippy --fix --allow-dirty --allow-staged

  # Test tasks
  test:
    desc: Run all tests
    cmds:
      - cargo test

  test:unit:
    desc: Run unit tests only
    cmds:
      - cargo test --lib

  test:integration:
    desc: Run integration tests (requires database)
    deps: [test:db:setup]
    cmds:
      - cargo test --test '*' -- --test-threads=1

  test:coverage:
    desc: Generate test coverage report
    cmds:
      - cargo tarpaulin --out Html --output-dir coverage

  # Watch tasks
  watch:
    desc: Watch for changes and rebuild
    cmds:
      - cargo watch -x build

  watch:test:
    desc: Watch for changes and run tests
    cmds:
      - cargo watch -x test

  # Run tasks
  run:
    desc: Run the application
    deps: [db:up]
    cmds:
      - cargo run

  run:dev:
    desc: Run in development mode with auto-reload
    deps: [db:up]
    cmds:
      - cargo watch -x run

  # Clean tasks
  clean:
    desc: Clean build artifacts
    cmds:
      - cargo clean

  clean:all:
    desc: Clean everything including database
    cmds:
      - cmd: task clean
      - cmd: task db:down
      - cmd: rm -rf target/

  # CI tasks (what runs in continuous integration)
  ci:local:
    desc: Run full CI pipeline locally
    cmds:
      - cmd: echo "Starting local CI pipeline..."
      - cmd: task fmt:check
      - cmd: task clippy
      - cmd: task test:db:setup
      - cmd: task build
      - cmd: task test:unit
      - cmd: task test:integration
      - cmd: echo "CI pipeline completed successfully!"

  ci:quick:
    desc: Quick CI check (no integration tests)
    cmds:
      - cmd: echo "Quick CI check..."
      - cmd: task fmt:check
      - cmd: task clippy
      - cmd: task build
      - cmd: task test:unit
      - cmd: echo "Quick check completed!"

  # Phase validation tasks
  validate:phase3:
    desc: Validate Phase 3 (Repositories)
    cmds:
      - cmd: echo "Validating Phase 3: Repository Layer"
      - cmd: task build
      - cmd: task test:unit
      - cmd: cargo test --lib repository
      - cmd: echo "Phase 3 validation complete"

  validate:phase4:
    desc: Validate Phase 4 (JWT & Password Utilities)
    cmds:
      - cmd: echo "Validating Phase 4: JWT & Password Utilities"
      - cmd: task build
      - cmd: task clippy
      - cmd: cargo test --lib utils
      - cmd: echo "Phase 4 validation complete"

  validate:phase5:
    desc: Validate Phase 5 (Service Layer)
    cmds:
      - cmd: echo "Validating Phase 5: Service Layer"
      - cmd: task build
      - cmd: task clippy
      - cmd: cargo test --lib services
      - cmd: echo "Phase 5 validation complete"

  validate:phase6:
    desc: Validate Phase 6 (Middleware & Extractors)
    cmds:
      - cmd: echo "Validating Phase 6: Middleware & Extractors Layer"
      - cmd: task build
      - cmd: task clippy
      - cmd: cargo test --lib middleware
      - cmd: cargo test --lib extractors
      - cmd: echo "Phase 6 validation complete"

  # Docker tasks
  docker:build:
    desc: Build Docker image
    dir: ..
    cmds:
      - docker-compose build backend

  docker:up:
    desc: Start all services with Docker Compose
    dir: ..
    cmds:
      - docker-compose up -d

  docker:down:
    desc: Stop all Docker services
    dir: ..
    cmds:
      - docker-compose down

  docker:logs:
    desc: View backend logs
    dir: ..
    cmds:
      - docker-compose logs -f backend

  # Development workflow tasks
  dev:setup:
    desc: Complete development environment setup
    cmds:
      - cmd: echo "Setting up development environment..."
      - cmd: task db:up
      - cmd: sleep 3
      - cmd: task db:setup
      - cmd: task build
      - cmd: echo "Development environment ready!"

  dev:reset:
    desc: Reset development environment
    cmds:
      - cmd: task clean:all
      - cmd: task dev:setup

  # Pre-commit hook
  pre-commit:
    desc: Run before committing (formatting, linting, tests)
    cmds:
      - cmd: echo "Running pre-commit checks..."
      - cmd: task fmt
      - cmd: task clippy
      - cmd: task test:unit
      - cmd: echo "Ready to commit!"

  # Release tasks
  release:check:
    desc: Check if ready for release
    cmds:
      - cmd: task fmt:check
      - cmd: task clippy
      - cmd: task test:db:setup
      - cmd: task test
      - cmd: task build:release
      - cmd: echo "Release checks passed!"
