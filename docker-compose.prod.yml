# Production Docker Compose for Hetzner deployment
# Usage: docker compose -f docker-compose.prod.yml up -d

services:
  # ========== DATABASE ==========
  postgres:
    image: postgres:16-alpine
    container_name: timemanager-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: timemanager
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: timemanager
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U timemanager"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - timemanager-network

  # ========== BACKEND ==========
  backend:
    image: ghcr.io/${GITHUB_REPOSITORY:-timemanager}/backend:${IMAGE_TAG:-latest}
    container_name: timemanager-backend
    restart: unless-stopped
    environment:
      APP_HOST: 0.0.0.0
      APP_PORT: 8080
      DATABASE_URL: postgres://timemanager:${POSTGRES_PASSWORD}@postgres:5432/timemanager
      RUST_LOG: ${RUST_LOG:-info}
      JWT_KEYS_PATH: /app/keys
      JWT_ACCESS_TOKEN_EXPIRY_SECONDS: ${JWT_ACCESS_TOKEN_EXPIRY_SECONDS:-900}
      JWT_REFRESH_TOKEN_EXPIRY_SECONDS: ${JWT_REFRESH_TOKEN_EXPIRY_SECONDS:-604800}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-https://${DOMAIN:-localhost}}
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@timemanager.local}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-Time Manager}
      FRONTEND_URL: ${FRONTEND_URL:-https://${DOMAIN:-localhost}}
    volumes:
      - jwt_keys:/app/keys
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.backend.middlewares=strip-api-prefix@file,security-headers@file,rate-limit-global@file"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
      # HTTP redirect
      - "traefik.http.routers.backend-http.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend-http.entrypoints=web"
      - "traefik.http.routers.backend-http.middlewares=redirect-to-https@file"
    networks:
      - timemanager-network

  # ========== FRONTEND ==========
  frontend:
    image: ghcr.io/${GITHUB_REPOSITORY:-timemanager}/frontend:${IMAGE_TAG:-latest}
    container_name: timemanager-frontend
    restart: unless-stopped
    depends_on:
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend.middlewares=security-headers@file"
      - "traefik.http.services.frontend.loadbalancer.server.port=8080"
      # HTTP redirect
      - "traefik.http.routers.frontend-http.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.routers.frontend-http.middlewares=redirect-to-https@file"
    networks:
      - timemanager-network

  # ========== TRAEFIK (Reverse Proxy + HTTPS) ==========
  traefik:
    image: traefik:v2.11
    container_name: timemanager-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./infrastructure/traefik/traefik-prod.yml:/etc/traefik/traefik.yml:ro"
      - "./infrastructure/traefik/dynamic-prod.yml:/etc/traefik/dynamic.yml:ro"
      - "letsencrypt_data:/letsencrypt"
    environment:
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL=${ACME_EMAIL:-admin@example.com}
    networks:
      - timemanager-network

volumes:
  postgres_data:
  jwt_keys:
  letsencrypt_data:

networks:
  timemanager-network:
    driver: bridge
